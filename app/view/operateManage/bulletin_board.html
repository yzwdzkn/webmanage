<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title><%=title%></title>

    <!-- layui  -->
    <link rel="stylesheet" href="/public/admin/static/layui/css/layui.css">
    <link rel="stylesheet" href="/public/admin/css/admin.css">

</head>
<body>

    
    <div style="padding: 15px;">
        <div class="layui-card">
            <div class="card-header">
                <span class="spanTitle"><%=title%></span>
                <br/>

                <div class="layui-form">
                        <div class="layui-row">
                        <div class="layui-input-inline btm_width_100">
                                <button type="button" class="layui-btn" onclick="openBulletinBoardPopup(0)">添加广告</button>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="_csrf" value="<%=csrf%>">
            </div>
            <div class="layui-card-body">
                <table class="layui-hide" id="tables" lay-filter="tables"></table>
            </div>
        </div>
    </div>
    
</body>
<div id="BulletinBoardPopup" class="popup">
    <div class="layui-form" action="">
        <input type="hidden" id="action" class="layui-input">
        <input type="hidden" id="id" class="layui-input">
        <div class="layui-form-item">
                <label class="layui-form-label">开启时间</label>
                <div class="layui-input-inline">
                    <input type="text" id="start_time" lay-verify="date" placeholder="开始时间" autocomplete="off" class="layui-input" readonly>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">关闭时间</label>
                <div class="layui-input-inline">
                    <input type="text" id="stop_time" lay-verify="date" placeholder="关闭时间" autocomplete="off" class="layui-input" readonly>
                </div>
            </div>
        <div class="layui-form-item">
            <label class="layui-form-label">标题</label>
            <div class="layui-input-block">
                <input type="text" id="title" class="layui-input">
            </div>
        </div>                  
        <div class="layui-form-item">
                <label class="layui-form-label">图片地址</label>
                <div class="layui-input-block">
                    <input type="hidden" id="img_url">
                    <input type="file" onchange="showImg()" id="img_file"><img src="" alt="" id="img_id" style="width: 100px">
                </div>
            </div>  
            <div class="layui-form-item">
                <label class="layui-form-label">状态</label>
                <div class="layui-input-block">
                    <input type="radio" name="type" value="0" title="开启" checked>
                    <input type="radio" name="type" value="1" title="关闭">
                </div>
            </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" onclick="saveBulletinBoard()">提交</button>
                <button class="layui-btn" onclick="closePopup()">取消</button>
            </div>
        </div>
    </div>
</div>

<script src="/public/admin/js/jquery.min.js"></script>
<!-- layui js -->
<script src="/public/admin/static/layui/layui.js"></script>
<script src="/public/admin/js/tabsIframeClose.js"></script>

    <script>
        var form, layer , table , indexPopup ;
        $(function(){
            layui.use(['element','form','layer','table','laydate'], function(){
                form = layui.form;
                table = layui.table;
                layer = layui.layer;
                var element = layui.element;
                var laydate = layui.laydate;
                initData();  
                laydate.render({
                 elem: '#start_time', //指定元素
                 format:"yyyy-MM-dd HH:mm:ss"
                 ,type: 'datetime'
                });
                laydate.render({
                 elem: '#stop_time', //指定元素
                 format:"yyyy-MM-dd HH:mm:ss"
                 ,type: 'datetime'
                });    
            });

            $("#search").click(function(){
                initData();
            });

        })

        function initData(){
            tableObj=table.render({
                elem: '#tables',
                title: '广告管理', //导出数据时的文件名
                url:'/admin/operateManage/bulletinBoard/list',
                where:{
                    // title:$("#s_title").val(),//搜索传入的值
                    _csrf:$("#_csrf").val()
                }, //其他请求参数
                page:true,
                cols: [[
                    //表格
                    {field:'id',title: '序号', sort: true,align:'center',width:100},
                    {field:'title', title: '标题', align:'center'},
                    {field:'img_url', title: '图片地址', align:'center'},
                    {field:'start_time', title: '开始时间', align:'center'},
                    {field:'stop_time', title: '结束时间', align:'center'},
                    {field:'create_time', title: '操作时间', align:'center'},
                    {field:'create_operator', title: '操作人', align:'center'},
                    {field:'type',title: '状态', sort: true, align:'center',width:100,
                        templet: function(row){
                            console.log(row)
                            if(row.type==0){
                                return "开启";
                            }else if(row.type==1){
                                return "<span style='color:red'>关闭</span>";
                            }
                        },//判断字体颜色
                    },
                    {field:'cz', title: '操作',align:'center',width:150,
                    templet: function(row){
                            return "<button type='button' class='layui-btn layui-btn-xs layui-btn-primary' onclick='openBulletinBoardPopup(1,"+row.id+")'>编辑</button><button type='button' class='layui-btn layui-btn-xs layui-btn-danger' onclick='deleteShare("+row.id+",\""+row.title+"\")'>删除</button>";
                        }
                    }
                ]]
            });
        }
        /**
         * 添加和编辑分享内容
         * 如果action==0做添加操作
         * 如果action==1做修改操作
         */

        function openBulletinBoardPopup(action,id){                        
            $("#action").val(action);
            if( action == 0 ){
                indexPopup = layer.open({
                    type: 1,
                    skin: 'layui-layer-demo', //样式类名
                    closeBtn: 0, //不显示关闭按钮
                    title: '添加广告',
                    anim: 2,
                    area: ['500px', '600px'],
                    shadeClose: false, //开启遮罩关闭
                    content: $("#BulletinBoardPopup")
                });
            }else if( action == 1 ){
                $.ajax({
                    url:"/admin/operateManage/bulletinBoard/get",
                    type:"POST",
                    data:{
                        id:id,
                        _csrf:$("#_csrf").val()},
                    timeout:60000, //1分钟
                    success:function(data){
                        console.log("data:",data);
                        if(data.status == 0){
                            //编辑时把值显示在编辑页面上
                            $("#id").val(data.bulletinBoard.id);
                            $("input[name='type'][value='"+data.bulletinBoard.type+"']").prop("checked",true);
                            $("#title").val(data.bulletinBoard.title);
                            $('#img_url').val(data.bulletinBoard.img_url);
                            $('#img_id').attr("src", data.bulletinBoard.img_url);
                            $("#start_time").val(data.bulletinBoard.start_time);
                            $("#stop_time").val(data.bulletinBoard.stop_time);
                            form.render(); 
                            indexPopup = layer.open({
                                type: 1,
                                skin: 'layui-layer-demo', //样式类名
                                closeBtn: 0, //不显示关闭按钮
                                title: '编辑',
                                anim: 2,
                                area: ['500px', '600px'],
                                shadeClose: false, //开启遮罩关闭
                                content: $("#BulletinBoardPopup")
                            });
                        }else{
                            layer.msg( data.msg || '操作失败');
                        }
                    },
                    error: function(xhr, status, error){
                        console.log("[ERROR] - ",error);
                    }
                })
            }   
        }
        /**
         * 提交分享
         */
        function saveBulletinBoard(){
            var action = $("#action").val();
            var id = $("#id").val(); 
            var title=$("#title").val();
            var img_url =  $("#img_url").val();
            var img_file = document.getElementById("img_file").files[0];
            var type =  $("input[name='type']:checked").val();
            var start_time=$("#start_time").val();
            var stop_time=$("#stop_time").val();
            if(title==""){
                layer.msg("标题不能为空");
              return;
            }
            if(action==0){
                if(img_file == undefined){
                    layer.msg("分享图片地址不能为空！");
                    return;
                }
            }
            var index = layer.load(1, {
                shade: [0.1,'#fff'] //0.1透明度的白色背景
            });
            var data = new FormData();
            data.append("action",action);
            data.append("id",id);
            data.append("type",type);
            data.append("title",title);
            data.append("img_url",img_url);
            data.append("file",img_file);
            data.append("start_time",start_time);
            data.append("stop_time",stop_time);
            $.ajax({
                url:"/admin/operateManage/bulletinBoard/saveBulletinBoard?_csrf="+$("#_csrf").val(),
                type:"POST",
                data:data,
                processData:false,
                contentType:false,
                timeout:60000, //1分钟
                success:function(data){
                    console.log(data);
                    layer.close(index);
                    if(data.status == 0){
                        layer.msg('操作成功');
                        reloadTable();
                        closePopup();
                    }else{
                        layer.msg( data.msg || '操作失败');
                    }
                },
                error: function(xhr, status, error){
                    console.log("[ERROR] - ",error);
                    layer.close(index);
                }
            })
        }

        /**
         *删除分享 
         */
        function deleteShare(id,title){
            layer.confirm("是否确认删除<span style='color:red'> "+title+" </span>这条广告？", {
                btn: ['确定','取消'] //按钮
            }, function(){
                var index = layer.load(1, {
                    shade: [0.1,'#fff'] //0.1透明度的白色背景
                });
                $.ajax({
                    url:"/admin/operateManage/bulletinBoard/deleteBulletinBoard",
                    type:"POST",
                    data:{id:id,_csrf:$("#_csrf").val()},
                    timeout:60000, //1分钟
                    success:function(data){
                        layer.close(index);
                        if(data.status == 0){
                            layer.msg('操作成功');
                            reloadTable();
                            closePopup();
                        }else{
                            layer.msg( data.msg || '操作失败');
                        }
                    },
                    error: function(xhr, status, error){
                        console.log("[ERROR] - ",error);
                        layer.close(index);
                    }
                })
            }, function(){
            });
        }
           /**
         * 点击取消清空数据
         */
         function closePopup(){
            layer.close(indexPopup);
            $("#action").val("");
            $("#id").val("");
            $("#title").val("");
            $("#start_time").val("");
            $("#stop_time").val("");
            $("#img_id").removeAttr('src');
            $("input[value='0']").prop("checked",true);
            document.getElementById('img_file').value = '';
            form.render('select'); 
            form.render('radio'); 
        }
        function reloadTable(){
          tableObj.reload({
            where: { //设定异步数据接口的额外参数，任意设
                _csrf:$("#_csrf").val()
            }
            // ,page: {
            //   curr: 1 //重新从第 1 页开始
            // }
          });
        }
        function showImg(){
            // var img_file =  $("#img_file").val();
            var file =  document.getElementById('img_file').files[0];
            var re = new FileReader();
            re.readAsDataURL(file);
            re.onload = function(re){
                $('#img_id').attr("src", re.target.result);
            }

        }
    </script>      
</html>