<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title><%=title%></title>
    
    <!-- layui  -->
    <link rel="stylesheet" href="/public/admin/static/layui/css/layui.css">
    <link rel="stylesheet" href="/public/admin/css/admin.css">
 
</head>
<body>
    <div class="layui-card">
        <div class="card-header">
            <div style="margin: 10px 0px 10px 25px;">
                <span class="spanTitle"><%=title%></span>
            </div>
            <div class="layui-form">
                <div class="layui-row">
                    <div class="layui-col-md4" style="text-align: left">
                        <div class="layui-input-inline btm_width_70">
                            <% if( childMenu.includes('bt1') ){ %> 
                                <button type="button" class="layui-btn" id="monitor_setting">监控设置</button>
                            <% } %> 
                        </div>
                    </div>
                    <div style="text-align: right">
                        <% if( childMenu.includes('bt2') ){ %> 
                            <div class="layui-input-inline" style="width: 250px;margin-left: 5px;text-align: left">
                                <select id="s_platform_id" lay-filter="s_platform_id">
                                    <option value="0" selected="">所有平台</option>
                                <% platformInfos.forEach(function(item){%>
                                    <option value="<%=item.platform_id %>" ><%=item.platform_id %> -- <%= item.platform_name %></option> 
                                    <% }) %>
                                </select>
                            </div>
                            <!-- <div class="layui-input-inline" style="width: 180px;margin-left: 5px;">
                                    <input type="text" id="e_platform_id"  placeholder="平台ID" class="layui-input">
                            </div>
                            <div class="layui-input-inline" style="width: 180px;margin-left: 5px;">
                                <input type="text" id="e_platform_name"  placeholder="平台名称" class="layui-input">
                            </div> -->
                            <div class="layui-input-inline btm_width_70">
                                    <button type="button" class="layui-btn" id="search">搜索</button>
                            </div>
                        <% } else {%>
                            <input type="hidden" id='s_platform_id' value="0">
                        <% } %> 
                    </div>
            </div>
        </div>
            <input type="hidden" id="detail_log_username" value="">
            <input type="hidden" id="_csrf" value="<%=csrf%>">
        </div>
        <div class="layui-card-body">
            <table class="layui-hide" id="tables" lay-filter="tables"></table>
        </div>
    </div>

</body>

<div id="monitoPopup" class="popup">
    <div class="layui-tab layui-tab-brief" style="position:relative;top: -30px;">
        <ul class="layui-tab-title">\
            <li class="layui-this">筛选条件</li>
            <li>高亮条件</li>
        </ul>
        <div class="layui-tab-content">
            <!--筛选条件-->
            <div class="layui-tab-item layui-show">
                <div class="layui-fluid">
                    <div class="layui-form-item">
                        <div class="layui-col-md4">
                            <label class="layui-form-label" style="width: 100%">游戏局数大于：</label>
                        </div>
                        <div class="layui-col-md4 layui-col-md-offset1" >
                            <input type="number" id="bet_count" class="layui-input" style="text-align: right">
                        </div>
                        
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-col-md4">
                            <label class="layui-form-label" style="width: 100%">杀数大于：</label>
                        </div>
                        <div class="layui-col-md4 layui-col-md-offset1" >
                            <input type="number" id="kill_number_gt" class="layui-input" style="text-align: right">                
                        </div>
                        <div class="layui-col-md1">
                            <label class="layui-form-label" style="width: 100%; text-align: left;">%</label>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-col-md4">
                            <label class="layui-form-label" style="width: 100%">杀数小于：</label>
                        </div>
                        <div  class="layui-col-md4 layui-col-md-offset1">
                            <input type="number" id="kill_number_lt" class="layui-input" style="text-align: right">
                        </div>
                        <div class="layui-col-md1">
                            <label class="layui-form-label" style="width: 100%; text-align: left;">%</label>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-col-md4">
                            <label class="layui-form-label" style="width: 100%">今日游戏局数大于：</label>
                        </div>
                        <div class="layui-col-md4 layui-col-md-offset1" >
                            <input type="number" id="today_bet_count" class="layui-input" style="text-align: right">
                        </div>
                        
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-col-md4">
                            <label class="layui-form-label" style="width: 100%">今日杀数大于：</label>
                        </div>
                        <div  class="layui-col-md4 layui-col-md-offset1">
                            <input type="number" id="today_kill_number_gt" class="layui-input" style="text-align: right">
                        </div>
                        <div class="layui-col-md1">
                            <label class="layui-form-label" style="width: 100%; text-align: left;">%</label>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-col-md4">
                            <label class="layui-form-label" style="width: 100%">今日杀数小于：</label>
                        </div>
                        <div  class="layui-col-md4 layui-col-md-offset1">
                            <input type="number" id="today_kill_number_lt" class="layui-input" style="text-align: right">
                        </div>
                        <div class="layui-col-md1">
                            <label class="layui-form-label" style="width: 100%; text-align: left;">%</label>
                        </div>
                    </div>
                </div>
            </div>
            <!--高亮条件-->
            <div class="layui-tab-item">
                <div class="layui-fluid">
                    <div class="layui-form-item">
                        <div class="layui-col-md4">
                            <label class="layui-form-label" style="width: 100%">游戏局数大于：</label>
                        </div>
                        <div class="layui-col-md4 layui-col-md-offset1" >
                            <input type="number" id="h_bet_count" class="layui-input" style="text-align: right">
                        </div>
                        
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-col-md4">
                            <label class="layui-form-label" style="width: 100%">杀数大于：</label>
                        </div>
                        <div class="layui-col-md4 layui-col-md-offset1" >
                            <input type="number" id="h_kill_number_gt" class="layui-input" style="text-align: right">                
                        </div>
                        <div class="layui-col-md1">
                            <label class="layui-form-label" style="width: 100%; text-align: left;">%</label>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-col-md4">
                            <label class="layui-form-label" style="width: 100%">杀数小于：</label>
                        </div>
                        <div  class="layui-col-md4 layui-col-md-offset1">
                            <input type="number" id="h_kill_number_lt" class="layui-input" style="text-align: right">
                        </div>
                        <div class="layui-col-md1">
                            <label class="layui-form-label" style="width: 100%; text-align: left;">%</label>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-col-md4">
                            <label class="layui-form-label" style="width: 100%">今日游戏局数大于：</label>
                        </div>
                        <div class="layui-col-md4 layui-col-md-offset1" >
                            <input type="number" id="h_today_bet_count" class="layui-input" style="text-align: right">
                        </div>
                        
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-col-md4">
                            <label class="layui-form-label" style="width: 100%">今日杀数大于：</label>
                        </div>
                        <div  class="layui-col-md4 layui-col-md-offset1">
                            <input type="number" id="h_today_kill_number_gt" class="layui-input" style="text-align: right">
                        </div>
                        <div class="layui-col-md1">
                            <label class="layui-form-label" style="width: 100%; text-align: left;">%</label>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-col-md4">
                            <label class="layui-form-label" style="width: 100%">今日杀数小于：</label>
                        </div>
                        <div  class="layui-col-md4 layui-col-md-offset1">
                            <input type="number" id="h_today_kill_number_lt" class="layui-input" style="text-align: right">
                        </div>
                        <div class="layui-col-md1">
                            <label class="layui-form-label" style="width: 100%; text-align: left;">%</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" onclick="saveMonitor()">提交</button>
            <button class="layui-btn" onclick="closePopup()">取消</button>
        </div>
    </div>

    </div>
</div>

<div class="popup" id="detailLogInit">
        <div style="float: right;">       
            <div class="layui-form">
                <div class="layui-inline">
                    <div class="layui-input-inline"  style=" width: 150px;">
                        <input type="text" id="s_game_no" class="layui-input" placeholder="牌局编号">
                    </div>
                </div>

                <div class="layui-input-inline" style="width: 160px;">
                    <input type="text" id="s_start_time" lay-verify="date" placeholder="开始时间" autocomplete="off" class="layui-input">
                </div>
                <div class="layui-input-inline" >
                    <span>-</span>
                </div>
                   
                <div class="layui-input-inline" style="width: 160px;">
                    <input type="text" id="s_end_time" lay-verify="date" placeholder="结束时间" autocomplete="off" class="layui-input">
                </div>

                <div class="layui-input-inline btm_width_70">
                    <button type="button" class="layui-btn" id="detail_search">搜索</button>
                </div>

                <div class="layui-input-inline btm_width_70">
                    <button type="button" class="layui-btn" onclick="detailExport()" >导出</button>
                </div>
            </div>
        </div>
        <br>
        <br>
        <div class="layui-card-body">
            <table class="layui-hide" id="detail_tables" lay-filter="detail_tables"></table>
        </div>
        
</div>


<div id="killPopup" class="popup">
    <div class="layui-form" action="">
        <input type="hidden" id="s_user_id" class="layui-input">
        <input type="hidden" id="s_username" class="layui-input">
        <div class="layui-form-item">
            <label class="layui-form-label">追杀状态</label>
            <div class="layui-input-block">
                <select id="kill_status" lay-filter="kill_status">
                    <option value="1" selected="">开始追杀</option>
                    <option value="0">取消追杀</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">追杀金额</label>
            <div class="layui-input-block">
                <input type="number" id="kill_money" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">追杀原因</label>
            <div class="layui-input-block">
                
                <input type="text" id="kill_remark" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" onclick="saveKill()">提交</button>
                <button class="layui-btn" onclick="closePopup()">取消</button>
            </div>
        </div>
    </div>
</div>

<script src="/public/admin/js/jquery.min.js"></script>
<script type="text/javascript" src="/public/admin/js/myExcel.js"></script>
<script type="text/javascript" src="/public/admin/js/xlsx.core.min.js"></script>
<!-- layui js -->
<script src="/public/admin/static/layui/layui.js"></script>
<script src="/public/admin/js/tabsIframeClose.js"></script>

    <script>
        var flag = eval('<%= childMenu.includes("bt1") || childMenu.includes("bt3") %>');
        var userMonitor = JSON.parse('<%-userMonitor%>')
        var form, layer , table , indexPopup ,tableObj,exportData ;
        $(function(){
            layui.use(['form','layer','laydate','table', 'element'], function(){
                form = layui.form;
                table = layui.table;
                layer = layui.layer;
                var laydate = layui.laydate;
                let element = layui.element;
                laydate.render({
                    elem: '#s_start_time',
                    type:"datetime",
                    format: 'yyyy-MM-dd HH:mm:ss',
                    value: new Date(Date.now() - (1000 * 60 * 60 * 24) * 7 ) // 7天内
                });
                laydate.render({
                    elem: '#s_end_time',
                    type:"datetime",
                    format: 'yyyy-MM-dd HH:mm:ss',
                    value: new Date()
                });
                form.on('select(kill_status)', function(data){   
                    var status = data.value;
                    var $kill_money = $("#kill_money");
                    if(status == 0){
                        $kill_money.val("0");
                        $kill_money.attr("disabled","disabled");
                        $kill_money.addClass("layui-btn-disabled");
                    }else{
                        $kill_money.removeAttr("disabled");
                        $kill_money.removeClass("layui-btn-disabled");
                    }
                });
                initData(); 
            });

            $("#search").click(function(){
                initData();
            })
            $("#monitor_setting").click(function(){
                openMonitorPopup();
            })

            setInterval(initData,20000)

        })



        function initData(){
            tableObj = table.render({
                elem: '#tables',
                title: '会员监控', //导出数据时的文件名
                url:'/admin/riskManagement/userMonitor/list',
                where:{

                    // e_platform_id:$("#e_platform_id").val(),
                    // e_platform_name:$("#e_platform_name").val(),
                    platform_id:$("#s_platform_id").val(),
                    _csrf:$("#_csrf").val()
                }, //其他请求参数
                page:true,
                cols: [[
                    // {field:'id', title: '会员ID', align:'center',sort: true},
                    {field:'username', title: '会员账号', align:'center'},
                    // {field:'platform_id', title: '平台ID', align:'center'},
                    {field:'platform_name', title: '平台名称', width:160, align:'center',
                            templet: function(row){
                                return row.platform_id+'--'+row.platform_name
                            }
                    },
                    {field:'valid_bet', title: '投注',align:'center',
                        templet: function(row){
                            if(row.PlayerData){
                                return (parseFloat(row.PlayerData.valid_bet) / 100).toFixed(2);
                            }else{
                                return 0;
                            }
                        }
                    },
                    {field:'total_games', title: '游戏局数',align:'center',
                        templet: function(row) {
                            return row.PlayerData !=null ? row.PlayerData.total_games: 0;
                        }
                    },
                    {field:'win_lost', title: '玩家输赢',width:160,align:'center',// dq 10-14
                        templet: function(row){
                            if(row.PlayerData){
                                let win_lost = parseFloat((row.PlayerData.win_gold - row.PlayerData.deduct_gold - row.PlayerData.lost_gold) / 100).toFixed(2);
                                return parseFloat(win_lost) >= 0? "<span style = 'color:green'>"+ win_lost + "</span>":"<span style = 'color:red'>"+ win_lost + "</span>" ;
                            }else{
                                return 0;
                            }
                        }
                    },
                    {field:'kill_number', title: '杀数',width:120,align:'center',sort: true,
                        templet: function(row){
                            if(row.PlayerData){
                                let kill_number = (parseFloat((row.PlayerData.win_gold - row.PlayerData.deduct_gold- row.PlayerData.lost_gold) / row.PlayerData.valid_bet) * -100).toFixed(2);
                                return parseFloat(kill_number) >= 0? "<span style = 'color:green'>"+ parseFloat(kill_number).toFixed(1) + "</span>"+'%':"<span style = 'color:red'>"+ kill_number + "</span>"+'%' ;
                            }else{
                                return 0;
                            }
                            
                        }
                    },
                    {field:'total_bet_number', title: '今日投注',width:100,align:'center',sort: true,
                        templet: function(row){
                            return parseFloat(row.todayData.valid_bet / 100).toFixed(2);
                            
                        }
                    },
                    {field:'today_total_games', title: '今日局数',width:100,align:'center',sort: true,
                        templet: function(row){
                            return row.todayData.total_games;
                            
                        }
                    },
                    {field:'today_lost_win', title: '今日输赢',width:100,align:'center',sort: true,
                        templet: function(row){
                            if(row.todayData){
                                let win_lost_t =  parseFloat((row.todayData.win_gold - row.todayData.deductGold - row.todayData.lost_gold) / 100).toFixed(2);
                                return parseFloat(win_lost_t) >= 0? "<span style = 'color:green'>"+ win_lost_t + "</span>":"<span style = 'color:red'>"+ win_lost_t + "</span>" ;
                            }else{
                                return 0;
                            }
                        }
                    },
                    {field:'today_kill_number', title: '今日杀数',width:100,align:'center',sort: true,
                        templet: function(row){
                            if (!row.todayData.total_games) return '-';
                            if(row.todayData){
                                let kill_number_t = (parseFloat((row.todayData.win_gold - row.todayData.lost_gold - row.todayData.deductGold) / row.todayData.valid_bet) * -100).toFixed(2);
                                return parseFloat(kill_number_t) >= 0? `<span style = 'color:green'> ${kill_number_t || 0}  </span>%` : `<span style = 'color:red'> ${kill_number_t || 0}  </span>%`;
                            }
                        }
                    },
                    {field:'isOnline', title: '状态',width:100,align:'center',
                        templet:function(row){
                            if(row.status){
                                return "<a href='#' style='color:red' onclick='changeUserStatus(\""+row.id+'\",\"' + row.username+ '"\,\"' +'1'+ "\")'>封禁</a>";
                            }else{
                                return "<a href='#' style='color:#4395ff' onclick='changeUserStatus(\"" + row.id + '\",\"' + row.username + '"\,\"' + '0' + "\")'>正常</a>";
                            }
                        }
                    },
                    {field:'kill_status', title: '追杀状态',align:'center',sort: true,
                        templet: function(row){
                            if(row.userKillRecord.status == 1){
                                return "<span style='color:red;cursor:pointer;''>追杀中</span>";
                            }else{
                                return "<span style='color:green;cursor:pointer;'>不追杀</span>";
                            }
                        }
                    },
                    {field:'', title: '操作',align:'center',hide:!flag,width:180,
                        templet: function(row){
                            var cz = "";
                            if(row.userKillRecord.status == 1){
                                cz += "<% if( childMenu.includes('bt1') ){ %>  <button type='button' class='layui-btn layui-btn-xs layui-btn' onclick='pursueKill(\""+row.id+"\",\""+ row.username +"\")'>设置</button> <% } %>" ;
                            }else{
                                cz += "<% if( childMenu.includes('bt3') ){ %>  <button type='button' class='layui-btn layui-btn-xs layui-btn' onclick='pursueKill(\""+row.id+"\",\""+ row.username +"\")'>追杀</button> <% } %>";
                            }
                            cz += "<% if( childMenu.includes('bt1') ){ %>  <button type='button' class='layui-btn layui-btn-xs layui-btn' onclick='detailLog(\""+row.username+"\")'>对局日志</button> <% } %>";
                            return cz;
                        }
                    }
                ]],
                done: function (res, curr, count) {
                    exportData=res.data;
                    for(let i =1; i < res.data.length + 1; i++) {
                        if (res.data[i-1].PlayerData && res.data[i-1].PlayerData.total_games >= userMonitor.h_bet_count) {
                            $($('tr')[i]).find('[data-field=total_games]').css('background-color', '#CCCCFF');
                        }
                        if (res.data[i-1].todayData && res.data[i-1].todayData.total_games >= userMonitor.h_today_bet_count) {
                            $($('tr')[i]).find('[data-field=today_total_games]').css('background-color', '#CCCCFF');
                        }
                        let killNumber = (parseFloat((res.data[i-1].PlayerData.win_gold - res.data[i-1].PlayerData.lost_gold) / res.data[i-1].PlayerData.valid_bet).toFixed(2) * -1) || 0;
                        let todayKillNumber = (parseFloat((res.data[i-1].todayData.win_gold - res.data[i-1].todayData.lost_gold) / res.data[i-1].todayData.valid_bet).toFixed(2) * -1) || 0;
                        if (res.data[i-1].PlayerData.total_games) {
                            if (killNumber > userMonitor.h_kill_number_gt) {
                                $($('tr')[i]).find('[data-field=kill_number]').css('background-color', '#afefff');
                            }
                            if (killNumber < userMonitor.h_kill_number_lt) {
                                $($('tr')[i]).find('[data-field=kill_number]').css('background-color', '#ffd8df');
                            }
                        }

                        if (res.data[i-1].todayData.total_games) {
                            if (todayKillNumber > userMonitor.h_today_kill_number_gt) {
                                $($('tr')[i]).find('[data-field=today_kill_number]').css('background-color', '#afefff');
                            }
                            if (todayKillNumber < userMonitor.h_today_kill_number_lt) {
                                $($('tr')[i]).find('[data-field=today_kill_number]').css('background-color', '#ffd8df');
                            }
                        }
                    }
                },
            });
            currentData = null;
            //监听行单击事件（单击事件为：rowDouble）
            table.on('row(tables)', function(obj){
                var data = obj.data;
                currentData = data;
                //标注选中样式
                obj.tr.addClass('layui-table-click').siblings().removeClass('layui-table-click');
            });
        }

        function changeUserStatus(user_id, username, status ){
            layer.confirm("是否确认切换<span style='color:red'> "+username+" </span>账户状态？", {
                btn: ['确定','取消'] //按钮
            }, function(){
                if(status == 0) {
                    status = 1
                } else {
                    status = 0
                }
                var index = layer.load(1, {
                    shade: [0.1,'#fff'] //0.1透明度的白色背景
                });
                $.ajax({
                    url:`/admin/riskManagement/userMonitor/userStatus`,
                    type:"PUT",
                    data:{id:user_id,status:status,_csrf:$("#_csrf").val()},
                    timeout: 60000, //1分钟
                    success: function(data){
                        layer.close(index);
                        if (data.status == 0) {
                            layer.msg('操作成功');
                            reloadTable();
                            closePopup();
                        } else {
                            layer.msg( data.msg || '操作失败');
                        }
                    },
                    error: function(xhr, status, error){
                        console.log("[ERROR] - ",error);
                        layer.close(index);
                    }
                })
            }, function(){
            });
        }
        
        function detailLog(username) {
            $("#detail_log_username").val(username)
            var table =layer.open({
                type: 1,
                shade: false,
                maxmin: true,
                content: $("#detailLogInit"),
                title: '详情日志',
                area: ['100%', '100%'],
            });
            detailLogInit(username);
        }

        function detailLogInit(username) {
            tableObj = table.render({
                elem: '#detail_tables',
                title: '对局日志详情', 
                url:'/admin/platformManage/userMonitor/detailLog',
                where:{
                    username: username,
                    game_no:$('#s_game_no').val(),
                    start_time:$('#s_start_time').val(),
                    end_time:$('#s_end_time').val(),
                    _csrf:$("#_csrf").val()
                }, //其他请求参数
                page:true,
                limit:10,
                cols: [[
                    {field:'create_time', title: '日期', align:'center',sort: true},
                    {field:'game_no', title: '牌局编号', align:'center',sort: true},
                    {field:'game_name', title: '游戏名称', align:'center',sort: true},
                    {field:'name_list', title: '参与id', width:80, align:'center'},
                    {field:'valid_bet', title: '投注',align:'center',sort: true, templet: function(row){
                        return (row.valid_bet/100).toFixed(2)
                    }},
                    {field:'profit', title: '输赢',align:'center',sort: true,templet: function(row){
                        return (row.profit/100).toFixed(2)
                    }},
                ]]
            });   
        }

        function detailExport() {
            let platform_id = $("#s_platform_id").val()
            let platform_name =  $("#s_platform_id").find('option:selected').text()
            let data = {
                    platform_name: platform_name,
                    platform_id:platform_id,
                    username: $("#detail_log_username").val(),
                    game_no:$('#s_game_no').val(),
                    start_time:$('#s_start_time').val(),
                    end_time:$('#s_end_time').val(),
                    _csrf:$("#_csrf").val()
                };
                let url = '/admin/userManage/cardGameQuery/export';
                let xhr = new XMLHttpRequest();
                    xhr.open('post', url, true);
                    xhr.setRequestHeader("Content-Type", "application/json");
                    data = JSON.stringify(data);
                    xhr.responseType = "blob"; // 返回类型blob，XMLHttpRequest支持二进制流类型
                    xhr.onload = function() {
                        if (this.status === 200) {  
                            let blob = this.response; //使用response作为返回，而非responseText
                            let reader = new FileReader();
                            reader.readAsDataURL(blob); // 转换为base64，可以直接放入a标签href
                            reader.onload = function(e) {
                            // 转换完成，创建一个a标签用于下载
                            let a = document.createElement("a");
                            a.download = "详情日志.xlsx";
                            a.href = e.target.result;
                            a.click();
                            layer.msg('下载成功');
                            };
                        } else {
                            layer.msg('下载失败');
                        }
                    };
                    xhr.send(data);
        }

        $("#detail_search").click(function() {
            var username = $("#detail_log_username").val()
            detailLogInit(username)
        })


        function openMonitorPopup(){
            $("#kill_number_gt").val( parseFloat(userMonitor.kill_number_gt * 100).toFixed(1));
            $("#kill_number_lt").val(parseFloat(userMonitor.kill_number_lt * 100).toFixed(1));
            $("#today_kill_number_gt").val(parseFloat(userMonitor.today_kill_number_gt * 100).toFixed(1));
            $("#today_kill_number_lt").val(parseFloat(userMonitor.today_kill_number_lt * 100).toFixed(1));
            $("#bet_count").val(userMonitor.bet_count);
            $("#today_bet_count").val(userMonitor.today_bet_count);
            $("#h_kill_number_gt").val( parseFloat(userMonitor.h_kill_number_gt * 100).toFixed(1));
            $("#h_kill_number_lt").val(parseFloat(userMonitor.h_kill_number_lt * 100).toFixed(1));
            $("#h_today_kill_number_gt").val(parseFloat(userMonitor.h_today_kill_number_gt * 100).toFixed(1));
            $("#h_today_kill_number_lt").val(parseFloat(userMonitor.h_today_kill_number_lt * 100).toFixed(1));
            $("#h_bet_count").val(userMonitor.h_bet_count);
            $("#h_today_bet_count").val(userMonitor.h_today_bet_count);

            indexPopup = layer.open({
                type: 1,
                skin: 'layui-layer-demo', //样式类名
                closeBtn: 1, //显示关闭按钮1
                cancel: function(index, layero){
                    closePopup();
                },
                title: '监控设置',
                anim: 2,
                area: ['520px', '550px'],
                shadeClose: false, //开启遮罩关闭
                content: $("#monitoPopup")
            }); 
        }

        function saveMonitor(){
            let kill_number_gt = $("#kill_number_gt").val() || 0;
            let kill_number_lt = $("#kill_number_lt").val() || 0;
            let today_kill_number_gt = $("#today_kill_number_gt").val() || 0;
            let today_kill_number_lt = $("#today_kill_number_lt").val() || 0;
            let bet_count = $("#bet_count").val();
            let today_bet_count = $("#today_bet_count").val();
            let h_kill_number_gt = $("#h_kill_number_gt").val() || 0;
            let h_kill_number_lt = $("#h_kill_number_lt").val() || 0;
            let h_today_kill_number_gt = $("#h_today_kill_number_gt").val() || 0;
            let h_today_kill_number_lt = $("#h_today_kill_number_lt").val() || 0;
            let h_bet_count = $("#h_bet_count").val();
            let h_today_bet_count = $("#h_today_bet_count").val();
            
            if(kill_number_gt == ""){
                kill_number_gt = 0;
            }

            if( kill_number_lt == ""){
                kill_number_lt = 0;
            }

            if(today_kill_number_gt == ""){
                today_kill_number_gt = 0;
            }

            if( today_kill_number_lt == ""){
                today_kill_number_lt = 0;
            }

            if(bet_count == ""){
                bet_count = 0;
            }

            if(today_bet_count == ""){
                bet_count = 0;
            }

            if(h_today_bet_count == ""){
                bet_count = 0;
            }

            if(parseFloat(kill_number_gt) > 500 || parseFloat(kill_number_gt) < -500){
                layer.msg("杀数范围错误（有效范围-500~500）");
                return;
            }

            if(parseFloat(kill_number_lt) > 500 || parseFloat(kill_number_lt) < -500){
                layer.msg("杀数范围错误（有效范围-500~500）");
                return;
            }

            if(parseFloat(today_kill_number_gt) > 500 || parseFloat(today_kill_number_gt) < -500){
                layer.msg("杀数范围错误（有效范围-500~500）");
                return;
            }

            if(parseFloat(today_kill_number_lt) > 500 || parseFloat(today_kill_number_lt) < -500){
                layer.msg("杀数范围错误（有效范围-500~500）");
                return;
            }

            if(parseInt(bet_count) > 99999999){
                layer.msg("局数设置不能大于99999999");
                return;
            }

            if(parseFloat(h_kill_number_gt) > 500 || parseFloat(h_kill_number_gt) < -500){
                layer.msg("杀数范围错误（有效范围-500~500）");
                return;
            }

            if(parseFloat(h_kill_number_lt) > 500 || parseFloat(h_kill_number_lt) < -500){
                layer.msg("杀数范围错误（有效范围-500~500）");
                return;
            }

            if(parseFloat(h_today_kill_number_gt) > 500 || parseFloat(h_today_kill_number_gt) < -500){
                layer.msg("杀数范围错误（有效范围-500~500）");
                return;
            }

            if(parseFloat(h_today_kill_number_lt) > 500 || parseFloat(h_today_kill_number_lt) < -500){
                layer.msg("杀数范围错误（有效范围-500~500）");
                return;
            }

            if(parseInt(h_bet_count) > 99999999){
                layer.msg("局数设置不能大于99999999");
                return;
            }

            if (bet_count > h_bet_count) {
                layer.msg('高亮局数不能小于筛选局数');
            }
            if (kill_number_gt > h_kill_number_gt) {
                layer.msg('高亮杀数大于不能小于筛选杀数大于');
            }
            if (kill_number_lt < h_kill_number_lt) {
                layer.msg('高亮杀数小于不能大于筛选杀数大于');
            }
            if (today_kill_number_gt > h_today_kill_number_gt) {
                layer.msg('高亮今日杀数大于不能小于筛选今日杀数大于');
            }
            if (today_kill_number_lt > h_today_kill_number_lt) {
                layer.msg('高亮今日杀数小于不能大于筛选今日杀数小于');
            }
            var index = layer.load(1, {
                shade: [0.1,'#fff'] //0.1透明度的白色背景
            });
            $.ajax({
                url:"/admin/riskManagement/userMonitor/saveMonitor",
                type:"POST",
                data:{
                    kill_number_gt: parseFloat(kill_number_gt / 100).toFixed(3),
                    kill_number_lt: parseFloat(kill_number_lt / 100).toFixed(3),
                    today_kill_number_gt: parseFloat(today_kill_number_gt / 100).toFixed(3),
                    today_kill_number_lt: parseFloat(today_kill_number_lt / 100).toFixed(3),
                    bet_count,
                    today_bet_count,
                    h_kill_number_gt: parseFloat(h_kill_number_gt / 100).toFixed(3),
                    h_kill_number_lt: parseFloat(h_kill_number_lt / 100).toFixed(3),
                    h_today_kill_number_gt: parseFloat(h_today_kill_number_gt / 100).toFixed(3),
                    h_today_kill_number_lt: parseFloat(h_today_kill_number_lt / 100).toFixed(3),
                    h_bet_count,
                    h_today_bet_count,
                    _csrf:$("#_csrf").val()
                },
                timeout:60000, //1分钟
                success:function(data){
                    layer.close(index);
                    if(data.status == 0){
                        layer.msg('操作成功');
                        closePopup();
                        userMonitor.kill_number_gt = parseFloat(kill_number_gt / 100).toFixed(3);
                        userMonitor.kill_number_lt = parseFloat(kill_number_lt / 100).toFixed(3);
                        userMonitor.today_kill_number_gt = parseFloat(today_kill_number_gt / 100).toFixed(3);
                        userMonitor.today_kill_number_lt = parseFloat(today_kill_number_lt / 100).toFixed(3);
                        userMonitor.bet_count = bet_count;
                        userMonitor.today_bet_count = today_bet_count;
                        userMonitor.h_kill_number_gt = parseFloat(h_kill_number_gt / 100).toFixed(3),
                        userMonitor.h_kill_number_lt =parseFloat(h_kill_number_lt / 100).toFixed(3),
                        userMonitor.h_today_kill_number_gt = parseFloat(h_today_kill_number_gt / 100).toFixed(3),
                        userMonitor.h_today_kill_number_lt = parseFloat(h_today_kill_number_lt / 100).toFixed(3),
                        userMonitor.h_bet_count = h_bet_count,
                        userMonitor.h_today_bet_count = h_today_bet_count,
                        initData()
                    }else{
                        layer.msg( data.msg || '操作失败');
                    }
                },
                error: function(xhr, status, error){
                    console.log("[ERROR] - ",error);
                    layer.close(index);
                }
            })
        }

        function closePopup(){
            layer.close(indexPopup);
            $("#kill_number_gt").val("");
            $("#kill_number_lt").val("");
            $("#bet_count").val("");
            $("#kill_money").val("").removeClass("layui-btn-disabled").removeAttr("disabled");
        }
        function reloadTable(){
          tableObj.reload({
            where: { //设定异步数据接口的额外参数，任意设
                username:$("#username").val(),
                _csrf:$("#_csrf").val()
            }
            // ,page: {
            //   curr: 1 //重新从第 1 页开始
            // }
          });
        }

        // 追杀
        function pursueKill(user_id,username) {
            $("#s_user_id").val(user_id);
            $("#s_username").val(username);
            $.ajax({
                url:"/admin/riskManagement/userKill/getUserKill",
                type:"get",
                data:{
                    "user_id" : user_id,
                    _csrf:$("#_csrf").val()
                },
                timeout:60000, //1分钟
                success:function(data){
                    if(data.status == 0){
                        if(data.kill){
                            $("#s_user_id").val(data.kill.user_id);
                            $("#kill_money").val(parseFloat(data.kill.kill_money / 100).toFixed(2));
                            $("#kill_status").val(data.kill.status);
                            $("#kill_remark").val(data.kill.kill_remark);
                            form.render('select'); 
                        }
                        indexPopup = layer.open({
                            type: 1,
                            skin: 'layui-layer-demo', //样式类名
                            closeBtn: 1, //显示关闭按钮1
                            cancel: function(index, layero){
                                closePopup();
                            },
                            title: '追杀设置',
                            anim: 2,
                            area: ['500px', '350px'],
                            shadeClose: false, //开启遮罩关闭
                            content: $("#killPopup")
                        }); 

                    }else{
                        layer.msg( data.msg || '操作失败');
                    }
                },
                error: function(xhr, status, error){
                    console.log("[ERROR] - ",error);
                    layer.close(index);
                }
            })
        }

        // 保存追杀设置
        function saveKill(){
            var user_id = $("#s_user_id").val();
            var kill_status = $("#kill_status").val();
            var kill_money = $("#kill_money").val();
            var kill_remark = $("#kill_remark").val();
            var username = $("#s_username").val();
            
            if((kill_status == "1") && kill_money == ""){
                layer.msg("请输入追杀金额！");
                return;
            }

            if((kill_status == "1") && kill_remark == ""){
                layer.msg("请输入追杀原因！");
                return;
            }
            if(kill_status == "0"){
                kill_money = 0 ;
            }
            if(kill_status == "1"){
                layer.confirm(`是否确认追杀玩家<b>${username}</b><b style="color:red;font-size:16px">${kill_money}</b>分`, {icon: 3,title:'开始追杀'}, function(index){
                    subKill();
                    layer.close(index);
                });
            }else{
                layer.confirm(`是否取消追杀玩家<b>${username}`, {icon: 3,title:'取消追杀'}, function(index){
                    subKill();
                    layer.close(index);
                });
            }
            
            function subKill(){
                var index = layer.load(1, {
                    shade: [0.1,'#fff'] //0.1透明度的白色背景
                });
                $.ajax({
                    url:"/admin/riskManagement/userKill/saveKill",
                    type:"POST",
                    data:{
                        "user_id" : user_id,
                        "kill_status":kill_status,
                        "kill_money":kill_money,
                        "kill_remark":kill_remark,
                        _csrf:$("#_csrf").val()
                    },
                    timeout:60000, //1分钟
                    success:function(data){
                        layer.close(index);
                        if(data.status == 0){
                            layer.msg('操作成功');
                            closePopup2();
                            reloadTable(); 
                        }else{
                            layer.msg( data.msg || '操作失败');
                        }
                    },
                    error: function(xhr, status, error){
                        console.log("[ERROR] - ",error);
                        layer.close(index);
                    }
                })
            }
        }

        // 取消
        function closePopup2(){
            layer.close(indexPopup);
            $("#s_user_id").val("");
            $("#kill_money").val("");
            $("#kill_status").val(1);
            $("#kill_remark").val("");
            form.render('select'); 
        }


    </script>      
</html>