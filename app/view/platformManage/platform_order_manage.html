<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title><%=title%></title>
    
    <!-- layui  -->
    <link rel="stylesheet" href="/public/admin/static/layui/css/layui.css">
    <link rel="stylesheet" href="/public/admin/css/admin.css">
    <style>
        /* .layui-card{
            margin: 20px 5%;
        } */
        .spanTitle{
            font-size: 26px;
        }
        .popup{
            padding: 20px;
            display: none;
        }
        .btm_width_70{
            margin-left: 5px; 
            margin-bottom: 2px; 
            width: 70px;
        }
        .btm_width_100{
            margin-left: 5px; 
            width: 100px;
        }
        a {
            color:rgb(100, 155, 18);
            cursor:pointer;
        }
        a:hover {
            color: aqua;
        }
    </style>
</head>
<body>
        <div class="layui-card">
            <div class="layui-card-header" style="padding-bottom:10px; height: 90px;">
                <span class="spanTitle"><%=title%></span>
                <br/>
    
                <div style="float: right;">
                    <div class="layui-form">

                        <div class="layui-inline" >
                            <div class="layui-input-block"style=" width: 180px;margin-left: 5px;">
                                <select id="type" lay-filter="type">
                                    <option value="-1" selected="">所有类型</option>
                                    <option value="0">会员上分</option>
                                    <option value="1">会员下分</option>
                                    <option value="2">后台上分</option>
                                    <option value="3">后台下分</option>
                                    <option value="4">平台下分失败</option>
                                    <option value="5">平台上分失败</option>
                                    <option value="6">回滚平台分数失败</option>
                                    <option value="7">回滚平台分数成功</option>
                                    <option value="8">代理充值</option>
                                    <option value="9">代理取款</option>
                                </select>
                            </div>
                        </div>

                        <div class="layui-inline" >
                            <div class="layui-input-block"style=" width: 180px;margin-left: 5px;">
                                <select id="order_state">
                                    <option value="0" selected="">处理类型</option>
                                    <option value="1">处理中</option>
                                    <option value="2">处理完成</option>
                                </select>
                            </div>
                        </div>
    

                        <div class="layui-input-inline" style=" width: 180px;margin-left: 5px;">
                            <select id="s_platform_id" lay-filter="s_platform_id">
                                <% platforms.forEach(function(item) { %>
                                <option value="<%= item.platform_id%>" <%if(item.platform_id==platform_id) { %>selected=''<% } %>    ><%=item.platform_id %> -- <%= item.platform_name %>
                                </option>
                                <% }) %>
                            </select>
                        </div>
                        <div class="layui-input-inline" style="width: 180px;">
                            <input type="text" id="start_date" lay-verify="date" placeholder="开始时间" autocomplete="off" class="layui-input">
                        </div>
                        <div class="layui-input-inline" >
                            <span>-</span>
                        </div>
                      
                        <div class="layui-input-inline" style="width: 180px;">
                            <input type="text" id="end_date" lay-verify="date" placeholder="结束时间" autocomplete="off" class="layui-input">
                        </div>
    
    
                        <div class="layui-inline" style=" width: 180px;margin-left: 5px;">
                            <input type="text" id="order_id"  placeholder="订单号" class="layui-input">
                        </div>
                        
                        <div class="layui-input-inline btm_width_140">
                            <button type="button" class="layui-btn" id="search">搜索</button>
                            <button type="button" class="layui-btn" id="export">导出</button>
                        </div>
                    </div>
                </div>
                
                <input type="hidden" id="_csrf" value="<%=csrf%>">
            </div>
            <div class="layui-card-body">
                <table class="layui-hide" id="tables" lay-filter="tables"></table>
            </div>
        </div>

</body>


<script src="/public/admin/js/jquery.min.js"></script>


<!-- layui js -->
<script src="/public/admin/static/layui/layui.js"></script>

    <script>
        var form, layer , table , indexPopup ;
        
        
        $(function(){
            $('#start_date').val('<%=date%>'+' 00:00:00');
            $('#end_date').val('<%=date%>'+ ' 23:59:59');

            layui.use(['element','form','layer','table','laydate'], function(){
                form = layui.form;
                table = layui.table;
                layer = layui.layer;
                var element = layui.element;
                var laydate = layui.laydate;

                laydate.render({
                    elem: '#start_date',
                    format: 'yyyy-MM-dd HH:mm:ss',
                    type:'datetime'
                    // value: '<%=date%>'
                });
                laydate.render({
                    elem: '#end_date',
                    format: 'yyyy-MM-dd HH:mm:ss',
                    type:'datetime'
                    // value: '<%=date%>'
                });
              
                initData();   
            });

            $("#search").click(function(){
                initData();
            });

            // 导出
            $("#export").click(function() {
                let data = {
                    order_state:$("#order_state").val(),
                    start_date: $("#start_date").val(),
                    end_date: $("#end_date").val(),
                    type: $("#type").val(),
                    order_id: $("#order_id").val(),
                    platform_id: $("#s_platform_id").val(),
                    _csrf:$("#_csrf").val()
                };
                let url = '/admin/platformManage/platformOrderManage/export';
                let xhr = new XMLHttpRequest();
                    xhr.open('post', url, true);
                    xhr.setRequestHeader("Content-Type", "application/json");
                    data = JSON.stringify(data);
                    xhr.responseType = "blob"; // 返回类型blob，XMLHttpRequest支持二进制流类型
                    xhr.onload = function() {
                        if (this.status === 200) {  
                            let blob = this.response; //使用response作为返回，而非responseText
                            let reader = new FileReader();
                            reader.readAsDataURL(blob); // 转换为base64，可以直接放入a标签href
                            reader.onload = function(e) {
                            // 转换完成，创建一个a标签用于下载
                            let a = document.createElement("a");
                            a.download = "平台账单明细.xlsx";
                            a.href = e.target.result;
                            a.click();
                            layer.msg('下载成功');
                            };
                        } else {
                            layer.msg('下载失败');
                        }
                    };
                    xhr.send(data);
            });

        })

        function initData(){
            var game_id = $("#s_game_id").val();
            table.render({
                elem: '#tables',
                title: '平台账变明细 ', //导出数据时的文件名
                url:'/admin/platformManage/platformOrderManage/list',
                where:{
                    order_state:$("#order_state").val(),
                    start_date:$("#start_date").val(),
                    end_date:$("#end_date").val(),
                    type:$("#type").val(),
                    order_id:$("#order_id").val(),
                    platform_id:$("#s_platform_id").val(),
                    _csrf:$("#_csrf").val()
                }, //其他请求参数
                page:true,
                cols: [[
                    {field:'order_time', title: '时间', align:'center',sort: true,width:180},
                    {field:'order_id', title: '订单号', align:'center',sort: true,width:230,
                        templet: function(row) {
                            return `<a onclick='copyOrderId("${row.order_id}")' id='${row.order_id}'>${row.order_id}</a>`;
                        }
                    },
                    // {field:'platform_id', title: '平台ID', align:'center',sort: true,},
                    {field:'paltform_name', title: '平台名称', align:'center', templet: function(row) {
                        return row.platform_info.platform_name
                    }},
                    {field:'type', title: '交易类型', align:'center',sort: true,
                        templet: function(row){
                            if(row.type == 0){
                                return "会员上分"
                            }else if(row.type == 1){
                                return "会员下分"
                            }else if(row.type == 2){
                                return "后台上分"
                            }else if(row.type == 3){
                                return "后台下分"
                            }else if(row.type == 4){
                                return "平台下分失败"
                            }else if(row.type == 5){
                                return "平台上分失败"
                            }else if(row.type == 6){
                                return "回滚平台分数失败"
                            }else if(row.type == 7){
                                return "回滚平台分数成功"
                            } else if(row.type == 8) {
                                return '代理充值'
                            } else if(row.type ==9) {
                                return '代理取款'
                            }
                        }
                    },
                    {field:'add_score', title: '交易金额', align:'center',
                        templet: function(row){
                        if( row.type == 0 || row.type == 3 || row.type == 4 || row.type == 8){
                            return parseFloat(row.add_score / -100).toFixed(2);
                        }else if(row.type == 1 || row.type == 2 || row.type == 5){
                            return parseFloat(row.add_score / 100).toFixed(2);
                        }else{
                            return parseFloat(row.add_score / 100).toFixed(2);
                        }
                        }
                    },
                    {field:'pre_score', title: '账前金额', align:'center',
                        templet: function(row){
                        return parseFloat(row.pre_score / 100).toFixed(2);
                        }
                    },
                    {field:'current_score', title: '账后金额', align:'center',
                    templet: function(row){
                            return parseFloat(row.current_score / 100).toFixed(2);
                        }
                    },
                    {field:'order_state', title: '处理状态', align:'center',sort: true,
                        templet: function(row){
                            if(row.order_state == 1){
                                return "处理中"
                            }else if(row.order_state == 2){
                                return "处理完成"
                            }else{
                            return "-"
                            }
                        }
                    },
                        // {field:'ip', title: 'IP', align:'center'},
                    {field:'create_operator', title: '操作人', align:'center'},
                ]]
            });
        }

        function copyOrderId(orderId) {
           document.addEventListener('copy', save);
           document.execCommand('copy');
           document.removeEventListener('copy', save);
           function save(e) {
            e.clipboardData.setData('text/plain', orderId);
            e.preventDefault();
           }
           layer.msg('复制成功');
        }
      
    </script>      
</html>