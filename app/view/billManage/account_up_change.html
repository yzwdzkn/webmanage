<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title><%=title%></title>

    <!-- layui  -->
    <link rel="stylesheet" href="/public/admin/static/layui/css/layui.css">
    <link rel="stylesheet" href="/public/admin/css/admin.css">
   
</head>
<body>
        <div style="padding: 15px;">
                <div class="layui-card">
                    <div class="card-header" style="padding-bottom:10px;">
                        <span class="spanTitle"><%=title%></span>
                        <div class="layui-form" style="text-align: right">
                                <div class="layui-row">
                                    <div class="layui-inline" >
                                            <div class="layui-input-block"style=" width: 150px;margin-left: 5px;text-align:left">
                                                <select id="s_agent_id" lay-filter="s_agent_id">
                                                    <% if(admin.account_type == 'Admin'){ %>
                                                        <option value="0" selected="">所有代理</option>
                                                        <% agents.forEach(function(item){%>
                                                        <option value="<%=item.id %>" ><%=item.username %></option>   
                                                        <% }) %>
                                                    <% }else{ %>
                                                        <% agents.forEach(function(item){%>
                                                            <% if(admin.account_type == 'Agent' && admin.id == item.id ){ %>
                                                            <option value="<%=item.id %>" selected=""><%=item.username %></option> 
                                                            <% } %>
                                                        <% }) %>
                                                    <% } %>
                                                </select>
                                            </div>
                                        </div>
                                                <div class="layui-inline" style="text-align: left">
                                                        <div class="layui-input-block"style=" width: 150px;margin-left: 5px;">
                                                            <select id="s_type" lay-filter="s_type">
                                                        <option value="-1">类型</option>
                                                        <!-- <option value="0">游戏上分</option>
                                                        <option value="1">游戏下分</option> -->
                                                        <option value="2">会员充值</option>
                                                        <!-- <option value="3">会员提现</option> -->
                                                        <option value="4">人工充值</option>
                                                        <!-- <option value="5">人工提现</option> -->
                                                        <option value="6">人工微信扫码</option>
                                                        <option value="7">人工支付宝扫码</option>
                                                        <option value="8">银行卡转账</option>
                                                        <option value="9">补发</option>
                                                        <option value="11">优惠赠送总额</option>
                                                        <!-- <option value="12">第三方下发</option> -->
                                                        <!-- <option value="13">其他</option> -->
                                                        <option value="100">十三水游戏上分</option>
                                                        <!-- <option value="-100">十三水游戏下分</option> -->
                                                        <option value="200">抢庄牛牛游戏上分</option>
                                                        <!-- <option value="-200">抢庄牛牛游戏下分</option> -->
                                                        <option value="300">二八杠游戏上分</option>
                                                        <!-- <option value="-300">二八杠游戏下分</option> -->
                                                        <option value="400">骰宝游戏上分</option>
                                                        <!-- <option value="-400">骰宝游戏下分</option> -->
                                                        <option value="500">炸金花游戏上分</option>
                                                        <!-- <option value="-500">炸金花游戏下分</option> -->
                                                        <option value="600">21点游戏上分</option>
                                                        <!-- <option value="-600">21点游戏下分</option> -->
                                                        <option value="700">斗地主游戏上分</option>
                                                        <!-- <option value="-700">斗地主游戏下分</option> -->
                                                        <option value="800">麻将游戏上分</option>
                                                        <!-- <option value="-800">麻将游戏下分</option> -->
                                                        <option value="900">百家乐游戏上分</option>
                                                        <!-- <option value="-900">百家乐游戏下分</option> -->
                                                        <option value="1000">德州扑克游戏上分</option>
                                                        <!-- <option value="-1000">德州扑克游戏下分</option> -->
                                                        <option value="1100">三公游戏上分</option>
                                                        <!-- <option value="-1100">三公游戏下分</option> -->
                                                        <option value="1200">抢庄牌九游戏上分</option>
                                                        <!-- <option value="-1200">抢庄牌九游戏下分</option> -->
                                                        <option value="1300">龙虎游戏上分</option>
                                                        <!-- <option value="-1300">龙虎游戏下分</option> -->
                                                        <option value="1400">看牌抢庄牛牛游戏上分</option>
                                                        <!-- <option value="-1400">看牌抢庄牛牛游戏下分</option> -->
                                                        <option value="1500">摇摇乐游戏上分</option>
                                                        <!-- <option value="-1500">摇摇乐游戏下分</option> -->
                                                        <option value="1600">抢红包游戏上分</option>
                                                        <!-- <option value="-1600">抢红包游戏下分</option> -->
                                                        <option value="1700">推筒子游戏上分</option>
                                                        <!-- <option value="-1700">推筒子游戏下分</option> -->
                                                        <option value="1800">百人牛牛游戏上分</option>
                                                        <!-- <option value="-1800">百人牛牛游戏下分</option> -->
                                                        <option value="1900">百人炸金花游戏上分</option>
                                                        <!-- <option value="-1900">百人炸金花游戏下分</option> -->
                                                        <option value="2000">百人德州游戏上分</option>
                                                        <!-- <option value="-2000">百人德州游戏下分</option> -->

                                                    </select>
                                                </div>
                                            </div>
                                                <div class="layui-inline" style="text-align: left">
                                                    <div class="layui-input-block"style=" width: 150px;margin-left: 5px;">
                                                        <select id="s_status" lay-filter="s_status">
                                                        <option value="-1">状态</option>
                                                        <option value="0">已处理</option>
                                                        <option value="1">未处理</option>
                                                        </select>
                                                    </div>
                                                </div>
                                  <div class="layui-input-inline" style="width: 180px;margin-left: 5px;">
                                        <input type="text" id="s_order_id"  placeholder="订单号" class="layui-input">
                                  </div>
                                  <div class="layui-input-inline" style="width: 180px;margin-left: 5px;">
                                      <input type="text" id="s_user_id"  placeholder="玩家ID;多个以英文逗号分隔" class="layui-input">
                                  </div>
                              
                                  <div class="layui-input-inline" style="width: 160px;margin-left: 5px;">
                                      <input type="text" id="s_start_date" lay-verify="date" placeholder="开始时间" autocomplete="off" class="layui-input">
                                  </div>
                                  <div class="layui-input-inline" >
                                      <span>-</span>
                                  </div>
                                  <div class="layui-input-inline" style="width: 160px;">
                                      <input type="text" id="s_end_date" lay-verify="date" placeholder="结束时间" autocomplete="off" class="layui-input">
                                  </div>  
                                  <div class="layui-input-inline btm_width_210">
                                            <button type="button" class="layui-btn" id="search">搜索</button>
                                            <button type="button" class="layui-btn" id="clear">重置</button>
                                            <button type="button" class="layui-btn" id="exportcount">导出</button>
                                    </div>
                              </div>
                          </div>
                        <input type="hidden" id="_csrf" value="<%=csrf%>">
                    </div>
                    <div class="layui-card-body">
                        <table class="layui-hide" id="tables" lay-filter="tables"></table>
                    </div>
                </div>
            </div>
        
</body>

<script src="/public/admin/js/jquery.min.js"></script>
<!-- layui js -->
<script src="/public/admin/static/layui/layui.js"></script>
<script src="/public/admin/js/tabsIframeClose.js"></script>

    <script>
        var form, layer , table , indexPopup ;
        var STATUS = {
                0: '已处理',
                1: '未处理',
            };
            var TYPE = {
                // 0: '游戏上分',
                // 1: '游戏下分',
                2:'会员充值',
                // 3:'会员提现',
                4:'人工充值',
                // 5:'人工提现',
                6:'人工微信扫码',
                7:'人工支付宝扫码',
                8:'银行卡转账',
                9:'补发',
                11:'优惠赠送总额',
                // 12: '第三方下发',
                // 13: '其他',
                
                100: '十三水游戏上分',
                // '-100': '十三水游戏下分',
                200: '抢庄牛牛游戏上分',
                // '-200': '抢庄牛牛游戏下分',
                300: '二八杠游戏上分',
                // '-300': '二八杠游戏下分',
                400: '骰宝游戏上分',
                // '-400': '骰宝游戏下分',
                500: '炸金花游戏上分',
                // '-500': '炸金花游戏下分',
                600: '21点游戏上分',
                // '-600': '21点游戏下分',
                700: '斗地主游戏上分',
                // '-700': '斗地主游戏下分',
                800: '麻将游戏上分',
                // '-800': '麻将游戏下分',
                900: '百家乐游戏上分',
                // '-900': '百家乐游戏下分',
                1000: '德州扑克游戏上分',
                // '-1000': '德州扑克游戏下分',
                1100: '三公游戏上分',
                // '-1100': '三公游戏下分',
                1200: '抢庄牌九游戏上分',
                // '-1200': '抢庄牌九游戏下分',
                1300: '龙虎游戏上分',
                // '-1300': '龙虎游戏下分',
                1400: '看牌抢庄牛牛游戏上分',
                // '-1400': '看牌抢庄牛牛游戏下分',
                1500: '摇摇乐游戏上分',
                // '-1500': '摇摇乐游戏下分',
                1600: '抢红包游戏上分',
                // '-1600': '抢红包游戏下分',
                1700: '推筒子游戏上分',
                // '-1700': '推筒子游戏下分',
                1800: '百人牛牛游戏上分',
                // '-1800': '百人牛牛游戏下分',
                1900: '百人炸金花游戏上分',
                // '-1900': '百人炸金花游戏下分',
                2000: '百人德州游戏上分',
                // '-2000': '百人德州游戏下分',
            };
        $(function(){
            layui.use(['element','form','layer','table','laydate'], function(){
                form = layui.form;
                table = layui.table;
                layer = layui.layer;
                var laydate = layui.laydate;
                var element = layui.element;
                laydate.render({
                    elem: '#s_start_date',
                    type:"date",
                    format: 'yyyy-MM-dd',
                    value: ''
                });
                laydate.render({
                    elem: '#s_end_date',
                    type:"date",
                    format: 'yyyy-MM-dd',
                    value: ''
                });   
                initData();   
            });

            $("#search").click(function(){
                initData();
            });
            $("#exportcount").click(function(){
                table.exportFile(insl.config.id,exportData,'xls');
            });
        })
        function initData(){
             insl=table.render({
                elem: '#tables',
                title: '会员账单明细', //导出数据时的文件名
                url:'/admin/billManage/accountUpChange/list',
                where:{
                    start_time:$("#s_start_date").val(),
                    end_time:$("#s_end_date").val(),
                    agents:$("#s_agent_id").val(),//代理
                    type:$("#s_type").val(),//类型
                    status:$("#s_status").val(),//状态
                    user_id:$("#s_user_id").val(),
                    order_id:$("#s_order_id").val(),

                    //搜索传入的值
                    _csrf:$("#_csrf").val()
                }, //其他请求参数
                page:true,
                limit:10,
                cols: [[
                    //表格
                    {field:'order_id',title: '订单号',align:'center',sort:true,width:160},
                    {field:'user_id',title: '会员ID',align:'center',sort:true},
                    {field:'type',title: '账单类型',align:'center',
                        templet: function(row){
                            return TYPE[row.type];
                        }
                    },
                    {field:'pre_score', title: '账前金额', align:'center',sort:true,
                        templet: function(row){
                            return row.pre_score/100;
                        }
                    },
                    {field:'score', title: '账单金额', align:'center',sort:true,
                        templet: function(row){
                            return row.pre_score>row.current_score ? row.score/-100 :row.score/100;
                        }
                    },
                    {field:'current_score', title: '账后金额', align:'center',sort:true,
                        templet: function(row){
                            return row.current_score/100
                        }
                    },
                    {field:'create_time', title: '创建时间', align:'center',sort:true},
                    {field:'update_time', title: '更新时间', align:'center',sort:true},
                    {field:'status', title: '状态', align:'center',width:130,
                        templet: function(row){
                            console.log(row);
                            if(row.lock_type == 0){
                                return STATUS[row.status]
                            }else{
                                return '已被' + row.lock_people + '锁定'
                            }
                        }
                    },
                    {field:'create_operator', title: '操作', align:'center',
                        templet: function(row){
                            if(row.lock_type == 1){
                                return  '';
                            }
                            return `<button type="button" class="layui-btn layui-btn-xs" onclick='LockOrder(${row.order_id})'>锁定</button>`
                        }
                    },
                    {field:'create_operator', title: '操作人员', align:'center',sort:true},
                ]],
                done: function (res, curr, count) {
                exportData=res.data;
            }
            });
        }
        function LockOrder(order_id){
            layer.confirm('确定要锁定该订单？', {
                btn: ['确定', '取消'], //可以无限个按钮
                },
                function(){
                    var index = layer.load(1, {
                    shade: [0.1,'#fff'] //0.1透明度的白色背景
                });
                    $.ajax({
                        url:`/admin/billManage/accountUpChange/lock`,
                        type:"POST",
                        data:{
                            order_id:order_id,
                            _csrf:$("#_csrf").val()
                        },
                        timeout: 60000, //1分钟
                        success:function(data){
                            layer.close(index);
                            if (data.status == 0) {
                                layer.msg('操作成功');
                                reloadTable();
                            } else {
                                layer.msg( data.msg || '操作失败');
                            }
                        }
                    })
                },
                function(index){
                });

        }
        function reloadTable(){
            insl.reload({
            where: { //设定异步数据接口的额外参数，任意设
                start_time:$("#s_start_date").val(),
                end_time:$("#s_end_date").val(),
                agents:$("#s_agent_id").val(),//代理
                type:$("#s_type").val(),//类型
                status:$("#s_status").val(),//状态
                user_id:$("#s_user_id").val(),
                order_id:$("#s_order_id").val(),
                _csrf:$("#_csrf").val()
            }
          });
        }
        $("#clear").click(function() {
            $("#s_agent_id").val('0')
            $("#s_type").val("-1")
            $("#s_status").val("-1")
            $("#s_order_id").val("")
            $("#s_user_id").val("")
            $("#s_start_date").val("")
            $("#s_end_date").val("")
            form.render()
        })
    </script>      
</html>